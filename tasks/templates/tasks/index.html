{% extends "tasks/layout.html" %}

{% block body %}
<h2>Your Tasks</h2>

<div class="accordion">
  {% for task in tasks %}
    <button class="accordion-btn">{{ task.name }}</button>
    <div class="accordion-content">
      <p>{{ task.description }}</p>
      <p><strong>Deadline:</strong> {{ task.deadline|default:"No deadline" }}</p>
      <p><strong>Status:</strong> {% if task.completed %}✅ Completed{% else %}❌ In Progress{% endif %}</p>

      <div class="d-flex mt-2">
        <a href="{% url 'task_detail' task.id %}" class="btn btn-primary btn-sm me-2">Details</a>
        <form action="{% url 'complete' task.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm"
                  {% if task.has_unmet_dependencies %}disabled{% endif %}>
            Complete
          </button>
        </form>
      </div>

      <!-- Subtasks -->
      {% for sub in task.subtasks.all %}
        <button class="accordion-btn ms-3">{{ sub.name }}</button>
        <div class="accordion-content">
          <p>{{ sub.description }}</p>
          <p><strong>Deadline:</strong> {{ sub.deadline|default:"No deadline" }}</p>
          <p><strong>Status:</strong> {% if sub.completed %}✅ Completed{% else %}❌ In Progress{% endif %}</p>

          <div class="d-flex mt-2">
            <a href="{% url 'task_detail' sub.id %}" class="btn btn-primary btn-sm me-2">Details</a>
            <form action="{% url 'complete' sub.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm">Complete</button>
            </form>
          </div>

          <!-- Sub-subtasks -->
          {% for subsub in sub.subtasks.all %}
            <button class="accordion-btn ms-4">{{ subsub.name }}</button>
            <div class="accordion-content">
              <p>{{ subsub.description|default:"No description" }}</p>
              <p><strong>Deadline:</strong> {{ subsub.deadline|default:"No deadline" }}</p>
              <p><strong>Status:</strong> {% if subsub.completed %}✅ Completed{% else %}❌ In Progress{% endif %}</p>

              <div class="d-flex mt-2">
                <a href="{% url 'task_detail' subsub.id %}" class="btn btn-primary btn-sm me-2">Details</a>
                <form action="{% url 'complete' subsub.id %}" method="post">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success btn-sm">Complete</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<script>
  document.querySelectorAll(".accordion-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const content = btn.nextElementSibling;
      if (!content) return;
      content.style.display = content.style.display === "block" ? "none" : "block";
    });
  });
</script>

<style>
  .accordion-btn {
    display: block;
    width: 100%;
    text-align: left;
    background: #eee;
    border: none;
    padding: 8px;
    cursor: pointer;
    margin-top: 4px;
  }
  .accordion-content {
    display: none;
    margin-left: 20px;
    padding: 4px;
    border-left: 2px solid #ccc;
  }
</style>
{% endblock %}
